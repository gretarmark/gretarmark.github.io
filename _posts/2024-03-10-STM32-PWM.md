---
layout: post
title: Pulse Width Modulation - STM32
published: true
---

Motors often use Pulse Width Modulation (PWM) to control their power output. PWM rapidly switches the power supply on and off, with the "on" time (duty cycle) determining the average power delivered. This technique works well for loads like motors that can't react quickly to these rapid changes. By adjusting the duty cycle, PWM efficiently regulates power without wasting energy.


## BLDC ESC PWM

In this post I will use PWM from STM32F407G Discovery board to control brushless direct current motor (BLDC) as seen in figure 1. The microcontroller is connected to 30A Electronic speed controller (ESC) (datasheet is found in [5]) as seen in figure 2 and then the ESC is connected to the BLDC.

Some motors use HALL effect sensor to measure the motors rotational direction as mentioned in [4], but the motors used in this post do not include HALL effect sensors. Instead the ESC measures the back EMF from the BLDC to know its rotational direction.

The ESC unit is connected to a Li-Po battery through the red and black thicker wires. The battery is shown in figure 3. The battery is rated with 3S which means it has 3 cells of 3.7V which sums up to 11.1V. The ESC has built-in voltage regulator and provides 5V, 2amp output between the thin red and black wires, so it is possible to power up your microcontroller using the battery and the ESC together. The white wire is used for the PWM signal. 

![Fig 1]({{ site.baseurl }}/images/PWM/BLDC_fig1.png "zero order"){:width=20%}  
**Figure 1: Brushless direct current motor (BLDC).**

![Fig 2]({{ site.baseurl }}/images/PWM/ESC.png "zero order"){:width=20%}  
**Figure 2: Electronic speed controller (ESC).**

![Fig 3]({{ site.baseurl }}/images/PWM/LIPO_Battery.png "zero order"){:width=20%}  
**Figure 3: HPI Plazma Li-Po Battery. 11.1V, 3200mAh, 40C, 3S.**



## PWM implementation using STM32 technology

![Fig 4]({{ site.baseurl }}/images/PWM/PWM_fig1_wiki.png "zero order"){:width=20%}  
**Figure 4: Duty Cycle, Wikipedia [3].**

* Step 1: Create project in STM32CubeIDE
* Step 2: Let the IDE initialize all peripherals automatically
* Step 3: Choose a pin where you want the PWM (Pulse Width Modulation) signal to be connected to. 
          The pin should be connected to a timer.
* Step 4: In my case I chose pin PA8 and I connected the pin to the timer "TIM1_CH1".
* Step 5: In my case the pin became orange, but it has to be green to become enabled. To fix this, we need to setup the timer in the clock configuration
          Any clock can be chosen, but I chose the HSI (High Speed Internal) clock connected to PLLCLK. The frequency can be chosen by equation 1.1 below. 
          $$f_{TC}$$ is the value HCLK(MHz) in clock configuration.

$$\\
\begin{align}
f_{PWM} &= \frac{f_{TC}}{(k_{PS}+1)(k_P+1)}   \tag{1.1}
\end{align}
\\$$

* $$f_{TC}$$: Frequency of a timer clock of an STM32 microcontroller$$
* $$k_{PS}$$: Prescaler value
* $$k_P$$: Period value

...Post in progress...

#### References

[1] PWM, HAL [Link](https://deepbluembedded.com/stm32-pwm-example-timer-pwm-mode-tutorial/)

[2] PWM, HAL. [Link](https://deepbluembedded.com/stm32-pwm-example-timer-pwm-mode-tutorial/)

[3] PWM, Wikipedia. [Link](https://en.wikipedia.org/wiki/Pulse-width_modulation)

[4] BLDC ESC PWM. The Engineering Mindset. Youtube. [Link](https://www.youtube.com/watch?v=yiD5nCfmbV0) 

[5] 30A BLDC ESC. Datasheet. [Link](https://www.optimusdigital.ro/index.php?controller=attachment&id_attachment=451)

